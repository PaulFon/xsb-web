<!DOCTYPE html>
<html lang="{{ locale|default('en') }}">
<head>
  <meta charset="utf-8"/>
  <title>
    {# Prefer new-style 'ordo.label' if present; fallback to 'calendar_label' #}
    {% if ordo is defined and ordo.label is defined %}{{ ordo.label }}{% else %}{{ calendar_label }}{% endif %}
  </title>
  <style>
    body { font-family: Georgia, serif; margin: 2rem; line-height: 1.6; }
    h1 { font-size: 1.8em; margin-bottom: 0; }
    h2 { font-size: 1.4em; color: #555; margin-top: 0.2em; }
    h3 { margin-top: 1.5em; }
    h4 { margin-top: 1em; }
    article { margin-top: .75em; }
  </style>
</head>
<body>
  {# ---------- Header(s) ---------- #}
  {% set header = (ordo.label if (ordo is defined and ordo.label is defined) else calendar_label) %}
  <h1>{{ header }}</h1>

  {# Show chosen set label if provided (supports several payload shapes) #}
  {% set chosen_label = (
        chosen_set.label if (chosen_set is defined and chosen_set.label is defined)
        else chosen_set_label if (chosen_set_label is defined)
        else None
      ) %}
  {% if chosen_label and chosen_label != header %}
    <h2>{{ chosen_label }}</h2>
  {% endif %}

  {# ---------- Propers ---------- #}
  <section id="propers" aria-labelledby="h-propers">
    <h3 id="h-propers">Propers</h3>

    {% set entrance = propers.entrance_html if (propers is defined and propers.entrance_html is defined) else propers.entrance if (propers is defined and propers.entrance is defined) else None %}
    {% set collect = propers.collect_html if (propers is defined and propers.collect_html is defined) else propers.collect if (propers is defined and propers.collect is defined) else None %}
    {% set communion = propers.communion_html if (propers is defined and propers.communion_html is defined) else propers.communion if (propers is defined and propers.communion is defined) else None %}
    {% set post = propers.post_communion_html if (propers is defined and propers.post_communion_html is defined) else propers.post_communion if (propers is defined and propers.post_communion is defined) else None %}

    {% if entrance %}<p><strong>Entrance Antiphon:</strong> {{ entrance|safe }}</p>{% endif %}
    {% if collect %}<p><strong>Collect:</strong> {{ collect|safe }}</p>{% endif %}
    {% if communion %}<p><strong>Communion Antiphon:</strong> {{ communion|safe }}</p>{% endif %}
    {% if post %}<p><strong>Post-Communion Prayer:</strong> {{ post|safe }}</p>{% endif %}
  </section>

  {# ---------- Readings ---------- #}
  <section id="readings" aria-labelledby="h-readings">
    <h3 id="h-readings">Readings</h3>
    {% for r in readings %}
      {# Support both r.ref_meta.reference / r.text_html / r.response_html and r.reference / r.text / r.response #}
      {% set ref = r.ref_meta.reference if (r.ref_meta is defined and r.ref_meta.reference is defined) else r.reference if r.reference is defined else None %}
      {% set txt = r.text_html if r.text_html is defined else r.text if r.text is defined else '' %}
      {% set resp = r.response_html if r.response_html is defined else r.response if r.response is defined else None %}
      <article class="reading">
        <h4>{{ r.role }}{% if ref %} â€” {{ ref }}{% endif %}</h4>
        {{ txt|safe }}
        {% if resp %}
          <p><em>Response:</em> {{ resp|safe }}</p>
        {% endif %}
      </article>
    {% endfor %}
  </section>
</body>
</html>